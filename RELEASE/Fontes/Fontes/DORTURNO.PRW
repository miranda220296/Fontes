#INCLUDE "PROTHEUS.CH"





















User function DORTURNO()

local OWIZARD
local OSTEP1
local OSTEP2
local OSTEP3
local OSTEP4
local OSTEP5

local CDIRLOCAL
local LPROCESSAR
local LCANCEL

local CARQUIVO
local ADADOSSRA
local ACAMPOS
local ALOGS

CARQUIVO := ""
ADADOSSRA := {}
ACAMPOS := {}
ALOGS := {}

CDIRLOCAL := ""
LPROCESSAR :=  .F. 
LCANCEL :=  .F. 

OWIZARD := FWWIZARDCONTROL():NEW(,{560,850})

OWIZARD:ACTIVEUISTEPS()




OSTEP1 := OWIZARD:ADDSTEP("Step1",{ | OPANEL |STEP1(OPANEL)})
OSTEP1:SETSTEPDESCRIPTION("Início")
OSTEP1:SETNEXTTITLE("Próximo")
OSTEP1:SETNEXTACTION({ || .T. })
OSTEP1:SETCANCELACTION(LCANCEL :=  .T. )




OSTEP2 := OWIZARD:ADDSTEP("Step2",{ | OPANEL |STEP2(OPANEL,@CARQUIVO)})
OSTEP2:SETSTEPDESCRIPTION("Seleção de Arquivo")
OSTEP2:SETNEXTTITLE("Próximo")
OSTEP2:SETNEXTACTION({ ||VALSTEP2(CARQUIVO)})
OSTEP2:SETCANCELACTION(LCANCEL :=  .T. )




OSTEP3 := OWIZARD:ADDSTEP("Step3",{ | OPANEL |STEP3(OPANEL,CARQUIVO,@ADADOSSRA,@ACAMPOS)})
OSTEP3:SETSTEPDESCRIPTION("Conferência dos Dados")
OSTEP3:SETNEXTTITLE("Próximo")
OSTEP3:SETNEXTACTION({ ||VALSTEP3(ADADOSSRA,ACAMPOS)})
OSTEP3:SETCANCELACTION(LCANCEL :=  .T. )




OSTEP4 := OWIZARD:ADDSTEP("Step4",{ | OPANEL |STEP4(OPANEL,CARQUIVO,ADADOSSRA,ACAMPOS)})
OSTEP4:SETSTEPDESCRIPTION("Processamento das correções")
OSTEP4:SETNEXTTITLE("Próximo")
OSTEP4:SETNEXTACTION({ || .T. })
OSTEP4:SETCANCELACTION(LCANCEL :=  .T. )




OSTEP5 := OWIZARD:ADDSTEP("Step5",{ | OPANEL |STEP5(OPANEL)})
OSTEP5:SETSTEPDESCRIPTION("Finalização")
OSTEP5:SETNEXTACTION({ || .T. })
OSTEP5:SETCANCELACTION(LCANCEL :=  .T. )

OWIZARD:ACTIVATE()

OWIZARD:DESTROY()

return 
















static function STEP1(OPANEL)

local OFONT
local OFONTV
local OSAYTOP
local OSAY1
local OSAY2

OFONT := TFONT():NEW(,,- (20), .T. , .T. ,,,,,)
OFONTV := TFONT():NEW(,,- (12), .T. , .T. ,,,,,)

OSAYTOP := TSAY():NEW(10,10,{ ||"Ajustes de campos na tabela SRA - Funcionários"},OPANEL,,OFONT,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(30,10,{ ||"Este programa tem como obejtivo realizar os devidos ajustes cadastrais na tabela SRA."},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(40,10,{ ||"Estes ajustes serão executados nos campos:"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(50,15,{ ||"- RA_SALARIO - Salário do Funcionário"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(60,15,{ ||"- RA_ANTEAUM - Salário Base Dissídio"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(70,15,{ ||"- RA_HRSMES  - Quantidade de Horas Mês"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(80,15,{ ||"- RA_HRSEMAN - Quantidade Horas Semanais"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(50,210,{ ||"- RA_HRSDIA  - Horas Dia"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(60,210,{ ||"- RA_TNOTRAB - Código Turno de Trabalho"},OPANEL,,,,,, .T. ,8388608,)
OSAY1 := TSAY():NEW(70,210,{ ||"- RA_INSMAX  - Horas Insalubridade"},OPANEL,,,,,, .T. ,8388608,)

OSAY2 := TSAY():NEW(110,10,{ ||"Importante: "},OPANEL,,OFONTV,,,, .T. ,8388608,)
OSAY2 := TSAY():NEW(120,10,{ ||"Os dados do arquivo CSV utilizados como base das correções, deverão seguir os mesmo moldes dos templates:"},OPANEL,,,,,, .T. ,8388608,)
OSAY2 := TSAY():NEW(130,15,{ ||"- Utilizar ponto e vírgula (;) como separador de colunas;"},OPANEL,,,,,, .T. ,8388608,)
OSAY2 := TSAY():NEW(140,15,{ ||"- Utilizar vírgula (,) como separador da parte decimal em campos numéricos;"},OPANEL,,,,,, .T. ,8388608,)
OSAY2 := TSAY():NEW(150,15,{ ||"- Utilizar 4 dígitos para especificar o ano em campos tipo 'data'. Ex.: dd/mm/aaaa;"},OPANEL,,,,,, .T. ,8388608,)
OSAY2 := TSAY():NEW(160,15,{ ||"- Retirar todos os caracteres especiais;"},OPANEL,,,,,, .T. ,8388608,)

return 

















static function STEP2(OPANEL,CARQUIVO)

local AAREA
local OBUTTON
local OGET1
local NALTGET

AAREA := GETAREA()

NALTGET := 13

OBUTTON := TBUTTON():NEW(70,10,"Selecione arquivo...",OPANEL,{ ||CARQUIVO := cGetFile("Arquivos .CSV|*.CSV","Selecione o arquivo a ser importado",0,, .F. ,48+0)},60,NALTGET+2,,, .F. , .T. , .F. ,, .F. ,,, .F. )
OGET1 := TGET():NEW(70,75,{ |U|iif(pcount()>0,CARQUIVO := U,CARQUIVO)},OPANEL,280,NALTGET,,,,,,,, .T. ,,,{ || .F. },,,,,,,"cArquivo")

RESTAREA(AAREA)

return 
















static function VALSTEP2(CARQUIVO)

local LRET

LRET :=  .T. 

if empty(CARQUIVO)
    LRET :=  .F. 
    HELP(" ",1,"Preenchimento",,"Selecione um Arquivo para poder prosseguir.",2,0,)
endif

return LRET



















static function STEP3(OPANEL,CARQUIVO,ADADOSSRA,ACAMPOS)

local OFUNC

ADADOSSRA := iif(ADADOSSRA==NIL,{},ADADOSSRA)
ACAMPOS := iif(ACAMPOS==NIL,{},ACAMPOS)

FWMSGRUN(OPANEL,{|OSAY|STEP3PROC(OSAY,CARQUIVO,ADADOSSRA,ACAMPOS)},"Processando","Gerando dados de conferência...")

OFUNC := TWBROWSE():NEW(0,0,(OPANEL:NCLIENTWIDTH) / (2),(OPANEL:NCLIENTHEIGHT) / (2),,,,OPANEL,,,,,,,,,,,, .F. ,, .T. ,, .F. ,,,)
OFUNC:SETARRAY(ADADOSSRA)

OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[1],{ ||ADADOSSRA[OFUNC:NAT][1]},,,,"LEFT",GETSX3CACHE(ACAMPOS[1],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[2],{ ||ADADOSSRA[OFUNC:NAT][2]},,,,"LEFT",GETSX3CACHE(ACAMPOS[2],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[3],{ ||ADADOSSRA[OFUNC:NAT][3]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[3],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[4],{ ||ADADOSSRA[OFUNC:NAT][4]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[3],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[5],{ ||ADADOSSRA[OFUNC:NAT][5]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[5],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[6],{ ||ADADOSSRA[OFUNC:NAT][6]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[5],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[7],{ ||ADADOSSRA[OFUNC:NAT][7]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[7],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[8],{ ||ADADOSSRA[OFUNC:NAT][8]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[7],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[9],{ ||ADADOSSRA[OFUNC:NAT][9]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[9],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[10],{ ||ADADOSSRA[OFUNC:NAT][10]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[9],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[11],{ ||ADADOSSRA[OFUNC:NAT][11]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[11],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[12],{ ||ADADOSSRA[OFUNC:NAT][12]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[11],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[13],{ ||ADADOSSRA[OFUNC:NAT][13]},,,,"LEFT",GETSX3CACHE(ACAMPOS[13],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[14],{ ||ADADOSSRA[OFUNC:NAT][14]},,,,"LEFT",GETSX3CACHE(ACAMPOS[13],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[15],{ ||ADADOSSRA[OFUNC:NAT][15]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[15],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))
OFUNC:ADDCOLUMN(TCCOLUMN():NEW(ACAMPOS[16],{ ||ADADOSSRA[OFUNC:NAT][16]},,,,"RIGHT",GETSX3CACHE(ACAMPOS[15],"X3_TAMANHO"), .F. , .F. ,,,, .F. ,))

return 

















static function VALSTEP3(ADADOSSRA,ACAMPOS)

local LRET

LRET :=  .T. 

if  len(ADADOSSRA)=0
    LRET :=  .F. 
    HELP(" ",1,"Inválido",,"Arquivo de dados inválido.",2,0,)
endif

if  len(ACAMPOS)=0
    LRET :=  .F. 
    HELP(" ",1,"Inválido",,"Arquivo de dados inválido.",2,0,)
endif

return LRET



















static function STEP4(OPANEL,CARQUIVO,ADADOSSRA,ACAMPOS)

ADADOSSRA := iif(ADADOSSRA==NIL,{},ADADOSSRA)
ACAMPOS := iif(ACAMPOS==NIL,{},ACAMPOS)
ALOGS := iif(ALOGS==NIL,{},ALOGS)

FWMSGRUN(OPANEL,{|OSAY|STEP4PROC(OSAY,ADADOSSRA,ACAMPOS,@ALOGS)},"Processando","Processando as correções...")

FWMSGRUN(OPANEL,{|OSAY|GERACSV(OSAY,ALOGS,CARQUIVO)},"Processando","Gerando arquivo de Logs...")

return 

















static function STEP5(OPANEL,ALOGS)

OFONT := TFONT():NEW(,,- (25), .T. , .T. ,,,,,)

OSAYTOP := TSAY():NEW(10,15,{ ||"Ajuste da tabela SRA efetuado com sucesso"},OPANEL,,OFONT,,,, .T. ,8388608,)
OSAYBOTTOM1 := TSAY():NEW(35,10,{ ||"Consulte o arquivo de log dos ajustes da tabela SRA."},OPANEL,,,,,, .T. ,8388608,)

return 















static function SELECTFILE()

local CMASKDIR := "Arquivos .CSV|*.CSV|Arquivos de texto|*.txt"
local CTITTELA := "Arquivo para a integracao"
local LINFOOPEN :=  .T. 
local LDIRSERVIDOR :=  .T. 
local COLDFILE := CARQUIVO

CARQUIVO := cGetFile(CMASKDIR,CTITTELA,,CARQUIVO,LINFOOPEN,48+0,LDIRSERVIDOR)

if .not. (empty( alltrim(CARQUIVO)))
    if .not. (file(CARQUIVO))
        iif(FindFunction("MsgStop"),MSGSTOP("Arquivo N? Existe!",),MsgStop("Arquivo N? Existe!",))
        CARQUIVO := COLDFILE
        return  .F. 
    endif
else 
    CARQUIVO := COLDFILE
endif

return CARQUIVO
















static function LEARQCONF(CFILEOPEN)

local ALISTA
local CBUFFER
local ALINHA

ALISTA := {}
CBUFFER := ""
ALINHA := {}

ft_fuse(CFILEOPEN)
ft_fgotop()

PROCREGUA(ft_flastrec())

while .not. (ft_feof())

    INCPROC("Obtendo dados "+cValToChar( len(ALISTA)))


    CBUFFER := ft_freadln()
    ALINHA := SEPARA( upper(CBUFFER),";")

    aadd(ALISTA,ALINHA)

    ft_fskip()
	
	endDo



ft_fuse()

return ALISTA



















static function STEP3PROC(OSAY,CARQUIVO,ADADOSSRA,ACAMPOS)

local CBUFFER
local ALINHA

CBUFFER := ""
ALINHA := {}

ft_fuse(CARQUIVO)
ft_fgotop()

while .not. (ft_feof()); 


    CBUFFER := ft_freadln()
    ALINHA := SEPARA( upper(CBUFFER),";")
    if  len(ACAMPOS)=0
        ACAMPOS := aclone(ALINHA)
    else 
        aadd(ADADOSSRA,ALINHA)
    endif

    ft_fskip()
	
	endDo



ft_fuse()

return  .T. 



















static function STEP4PROC(OSAY,ADADOSSRA,ACAMPOS,ALOGS)

local NX
local CQRY
local CRET
local NSTATUS

local NSALAROLD
local NSALARNEW
local NANTEAOLD
local NANTEANEW
local NHRMESOLD
local NHRMESNEW
local NHRSEMOLD
local NHRSEMNEW
local NHRDIAOLD
local NHRDIANEW
local CTURNOOLD
local CTURNONEW
local NINSMAOLD
local NINSMANEW

ALOGS := iif(ALOGS==NIL,{},ALOGS)

for NX := 1 to ( len(ADADOSSRA)) step 1

    NSALAROLD := iif(empty(ADADOSSRA[NX][3]),0, val(strtran(ADADOSSRA[NX][3],",",".")))
    NSALARNEW := iif(empty(ADADOSSRA[NX][4]),0, val(strtran(ADADOSSRA[NX][4],",",".")))

    NANTEAOLD := iif(empty(ADADOSSRA[NX][5]),0, val(strtran(ADADOSSRA[NX][3],",",".")))
    NANTEANEW := iif(empty(ADADOSSRA[NX][6]),0, val(strtran(ADADOSSRA[NX][4],",",".")))

    NHRMESOLD := iif(empty(ADADOSSRA[NX][7]),0, val(strtran(ADADOSSRA[NX][7],",",".")))
    NHRMESNEW := iif(empty(ADADOSSRA[NX][8]),0, val(strtran(ADADOSSRA[NX][8],",",".")))

    NHRSEMOLD := iif(empty(ADADOSSRA[NX][9]),0, val(strtran(ADADOSSRA[NX][9],",",".")))
    NHRSEMNEW := iif(empty(ADADOSSRA[NX][10]),0, val(strtran(ADADOSSRA[NX][10],",",".")))

    NHRDIAOLD := iif(empty(ADADOSSRA[NX][11]),0, val(strtran(ADADOSSRA[NX][11],",",".")))
    NHRDIANEW := iif(empty(ADADOSSRA[NX][12]),0, val(strtran(ADADOSSRA[NX][12],",",".")))

    CTURNOOLD := ADADOSSRA[NX][13]
    CTURNONEW := ADADOSSRA[NX][14]

    NINSMAOLD := iif(empty(ADADOSSRA[NX][15]),0, val(strtran(ADADOSSRA[NX][15],",",".")))
    NINSMANEW := iif(empty(ADADOSSRA[NX][16]),0, val(strtran(ADADOSSRA[NX][16],",",".")))

    CQRY := "UPDATE "+RETSQLNAME("SRA")
    CQRY += " SET "+ACAMPOS[3]+" = '"+cValToChar(NSALARNEW)+"' "
    CQRY += ", "+ACAMPOS[5]+" = '"+cValToChar(NANTEANEW)+"' "
    CQRY += ", "+ACAMPOS[7]+" = '"+cValToChar(NHRMESNEW)+"' "
    CQRY += ", "+ACAMPOS[9]+" = '"+cValToChar(NHRSEMNEW)+"' "
    CQRY += ", "+ACAMPOS[11]+" = '"+cValToChar(NHRDIANEW)+"' "
    CQRY += ", "+ACAMPOS[13]+" = '"+CTURNONEW+"' "
    CQRY += ", "+ACAMPOS[15]+" = '"+cValToChar(NINSMANEW)+"' "
    CQRY += " WHERE "+ACAMPOS[1]+" = '"+ADADOSSRA[NX][1]+"' "
    CQRY += "  AND "+ACAMPOS[2]+" = '"+ADADOSSRA[NX][2]+"' "; 

        Begin Transaction

        NSTATUS := TCSqlExec(CQRY)

        if NSTATUS<0
            CRET := " -> "+TCSqlError()
        else 
            CRET := " -> Operação executada com sucesso"
        endif

        End Transaction

    aadd(ALOGS,CQRY+CRET)
next


return  .T. 


















static function GERACSV(OSAY,ALOGS,CARQUIVO)

// local OEXCEL
local NFILE
local CDRIVE
local CDIR
local CNOME
local CEXT

local CARQ
local CPATH
local NX

SplitPath(CARQUIVO,CDRIVE,CDIR,CNOME,CEXT)

// if .not. (APOLECLIENT("MSExcel"))
//     iif(FindFunction("APMsgAlert"),APMSGALERT("Microsoft Excel não instalado!",),MsgAlert("Microsoft Excel não instalado!",))
//     return 
// endif

CARQ := CNOME+"_LOG."+CEXT

CPATH := CDRIVE+CDIR

NFILE := fcreate(CPATH+CARQ)

if NFILE==- (1)
    iif(FindFunction("MsgAlert"),MSGALERT("Nao conseguiu criar o arquivo!",),MsgAlert("Nao conseguiu criar o arquivo!",))
    return 
endif

for NX := 1 to ( len(ALOGS)) step 1
    fwrite(NFILE,ALOGS[NX]+CHR(13)+CHR(10))
next

fclose(NFILE)

// OEXCEL := MSEXCEL():NEW()
// OEXCEL:WORKBOOKS:OPEN(CPATH+CARQ)
// OEXCEL:SETVISIBLE( .T. )
// OEXCEL:DESTROY()
ShellExecute("open",CPATH+CARQ,"","",1)
return 































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































